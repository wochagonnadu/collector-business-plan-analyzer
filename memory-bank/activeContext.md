# Active Context: Collector Business Plan Analyzer

## Current Focus

*   **Phase 2 Implementation:** Building out the core functionality and UI for the main modules. Focus is shifting towards implementing core calculation logic, visualizations, and remaining UI refinements (like stage dependency logic).

## Recent Changes (Since Last Update)

*   **Staff Module:** Implemented delete functionality and sorting in `StaffTable`. Added text filtering functionality for 'Group' and 'Position' columns in `StaffTable.tsx` using `TextField` inputs and state management.
*   **Staff Module:** Implemented delete functionality and sorting in `StaffTable`. Added text filtering functionality for 'Group' and 'Position' columns in `StaffTable.tsx` using `TextField` inputs and state management. **Updated `StaffType`** (in `types/staff.ts`) to include `efficiencyPercent` (replacing `efficiencyRatio`) and optional `maxCaseload`. **Updated `staffSlice`** (`store/slices/staffSlice.ts`) to reflect `StaffType` changes. **Updated `StaffForm`** (`components/StaffManagement/StaffForm.tsx`) to include input fields and validation for `efficiencyPercent` and `maxCaseload`.
*   **Stages Module:** Implemented `StageForm` (including dependency selection UI) and `SubStageForm` components. Integrated forms into `StagesConfigurator` using Modals for Add/Edit functionality. Enabled validation for `StageForm`. Implemented delete functionality for stages and sub-stages. **Updated `WorkflowVisualizer`** to display stage names and their immediate next stages based on `nextStageIds`. Added `nextStageIds` property to `Stage` type definition.
*   **Costs Module:** Implemented `CostInputForm` and basic `CostTable`. **Added sorting and filtering (by name, tag, periodicity) functionality to `CostTable`** (`components/CostManagement/CostTable.tsx`).
*   **Labor Cost Module:** Implemented `CaseloadDistributionConfig` component with state synchronization and validation. Implemented basic `distributeCases` and `calculateAnnualCaseloadLaborCost` logic in `utils/laborCostCalculations.ts`. Integrated `CaseloadDistributionConfig` into `FinancialModelingPage`. Implemented `DistributionVisualizer` with Recharts PieChart. **Refined `calculateSubStageExecutionCost`** (in `utils/staffCalculations.ts`) to use `efficiencyPercent`. **Renamed `calculateTotalAnnualWorkHours` to `calculateAvailableMonthlyWorkHours`** (in `utils/staffCalculations.ts`) and adjusted to calculate monthly capacity. **Added `calculateSubStageEffectiveHours`** (in `utils/staffCalculations.ts`) to calculate efficiency-adjusted time per sub-stage. **Added `calculateRequiredAnnualWorkloadHours`** (in `utils/laborCostCalculations.ts`) to calculate workload demand considering efficiency. **Updated `LaborCostDisplay`** (`components/LaborCost/LaborCostDisplay.tsx`) to show efficiency-adjusted variable cost, fixed cost, total cost, required workload, available capacity, and utilization percentage.
*   **Financials Module:** Implemented initial calculation logic for `generateCashFlow`, `generatePnL`, `calculateBreakEven`, `calculateNPV`, `calculateEBITDA`, `calculateAverageCollectionTime`, `calculateOverallRecoveryRate`, `calculateCostPerCase` in `utils/calculations.ts` and `utils/processCalculations.ts`. Integrated these calculations into `FinancialReport` and `FinancialMetricsDisplay` components. Implemented `TimelineVisualizer` with basic Recharts LineChart for cumulative CF. Refined `variableOtherCostPerCase` calculation within `calculateBreakEven` in `utils/financialMetricsCalculations.ts` to correctly account for cost periodicity. Implemented `calculateIRR` function in `utils/financialMetricsCalculations.ts` using the `irr` library (dependency added), created necessary type declaration file (`src/types/irr.d.ts`), and annualized the result. **Implemented case flow simulation for `calculateOverallRecoveryRate`:** Added `writeOffProbability` to `Stage` type, updated `stagesSlice` and `StageForm` UI/validation. Created `simulateCaseFlowAndRecovery` function in `utils/processCalculations.ts` using BFS to model case flow based on dependencies, recovery, and write-off probabilities (simplified equal distribution for multiple next stages). Refactored `calculateOverallRecoveryRate` to use the simulation. **Implemented time-based case flow simulation (`simulateMonthlyCaseFlow`) in `monthlySimulation.ts`:** This simulation models month-by-month case progression based on stage durations (`max`) and probabilities to distribute income and variable labor costs more accurately over the 12-month Cash Flow period. Refactored `generateCashFlow` to use this simulation's output, replacing the previous linear distribution logic. **Refined variable labor cost distribution within `simulateMonthlyCaseFlow`** to be proportional to monthly work completion percentage instead of simple averaging. **Implemented Staff Capacity Constraint in `simulateMonthlyCaseFlow`:** The simulation now calculates monthly available staff hours (`calculateAvailableMonthlyWorkHours`) and required workload hours (based on active cases, stage durations, and `calculateSubStageEffectiveHours`). If required hours exceed available hours, case progression (`daysInStage`) is slowed proportionally using a `capacityFactor`, realistically delaying income and cost recognition. Made depreciation period configurable: added `depreciationPeriodYears` to `FinancialParams` type and `financialsSlice` state, added input to `FinancialParamsConfig` UI, and updated `calculateEBITDA` in `utils/financialMetricsCalculations.ts` to use the configured value. Updated `generatePnL` to use refined operational cost data from the updated `generateCashFlow`. **Implemented `calculateAverageCollectionTime` in `processCalculations.ts`** using BFS to account for stage dependencies, durations, and probabilities. **Refined Scenario Logic:** Updated `Scenario` type (`types/financials.ts`) to include `staffList`, `stageList`, `costList`, `caseloadDistribution`. Updated `saveScenario` reducer (`financialsSlice.ts`) to store deep copies of these states. Added `setStaffList`, `setStageList`, `setCostList` actions to respective slices. Created `loadScenarioAndDependencies` thunk action (`financialsSlice.ts`) to orchestrate loading full scenario state across slices. Updated `ScenarioComparison.tsx` to use the new save payload and load thunk.
*   **Dashboard Module:** Created `FinancialMetricsDisplay` component and integrated calculated metrics. Created `KeyCharts` component and implemented basic CF LineChart and P&L BarChart using Recharts. Integrated `KeyCharts` into `DashboardPage`. Fixed layout issue in `DashboardPage.tsx` where `KeyCharts` were flowing incorrectly by adding a defined, responsive height (`height: { xs: 500, md: 400 }`) to the wrapping `Box` container, ensuring `ResponsiveContainer` within `KeyCharts` renders correctly.
*   **Layout:** Adjusted main content width by removing the `maxWidth` constraint from the `<Container>` in `Layout.tsx`. **Fixed global layout issue** by removing width constraints and centering styles from `#root` (in `App.css`) and `body` (in `index.css`), allowing the header and application to span the full browser width.
*   **Dashboard Module:** Created `FinancialMetricsDisplay` component and integrated calculated metrics. Created `KeyCharts` component and implemented basic CF LineChart and P&L BarChart using Recharts. Integrated `KeyCharts` into `DashboardPage`. Fixed layout issue in `DashboardPage.tsx` where `KeyCharts` were flowing incorrectly by adding a defined, responsive height. **Adjusted card widths** on the dashboard (`DashboardPage.tsx`) to make the top two cards (`LaborCostDisplay`, `FinancialMetricsDisplay`) wider (approx. 50% each on large screens) for better readability.
*   **Stages Module:** Implemented `StageForm` (including dependency selection UI) and `SubStageForm` components. Integrated forms into `StagesConfigurator` using Modals for Add/Edit functionality. Enabled validation for `StageForm`. Implemented delete functionality for stages and sub-stages. Added `nextStageIds` property to `Stage` type definition. **Updated `StagesConfigurator.tsx`** to display recovery and write-off probabilities in the accordion summary for each stage. **Refactored `WorkflowVisualizer.tsx`** to display stages in a vertical flowchart layout (using MUI Stack/Paper) instead of horizontal chips. The new visualization includes stage name, duration, recovery probability (green), write-off probability (red), and a list of substages within each stage block. **Fixed percentage display** in both `StagesConfigurator.tsx` (accordion summary) and `WorkflowVisualizer.tsx` to correctly format probabilities (removed incorrect multiplication by 100).
*   **Financials Module:** ... (previous entries) ... **Added Income Row to Horizontal CF Report:** Updated `HorizontalCashflowReport.tsx` to fetch necessary state slices, calculate cash flow using `generateCashFlow` within `useMemo`, and display the calculated monthly `inflow` as a dedicated "Поступления (от взыскания)" row in the table. **Refactored Financial Reports:** Moved core calculations (`generateCashFlow`, `aggregateReportData`, `generatePnL`, `totalPnlData`) from `FinancialReport` and `HorizontalCashflowReport` to the parent `FinancialModelingPage`. Updated `FinancialReport` and `HorizontalCashflowReport` to accept calculated data (`aggregatedReportData`, `totalPnlData`, `modelingYear`, `currentParams`) via props, removing internal calculations. Ensured the summary CF table in `FinancialReport` derives its displayed values directly from the `aggregatedReportData` prop for consistency with the detailed report. // Рефакторинг финансовых отчетов для централизации расчетов и передачи данных через props.

## Immediate Next Steps

1.  **Refine Financial Modeling (Task 6 - Remaining):** Refine Scenario comparison UI.
2.  **Refine Visualizations (Task 7):** Improve existing charts (CF, P&L, Distribution) and potentially add more (e.g., break-even chart, capacity vs workload chart, monthly utilization).
3.  **Testing (Task 8):** Add unit/integration tests for recent calculation changes (dependencies, efficiency, **capacity constraint simulation**, scenarios) and UI refinements (table sorting/filtering).
4.  **Refine Visualizations (Task 7):** Improve existing charts (CF, P&L, Distribution) and potentially add more (e.g., break-even chart, capacity vs workload chart).
5.  **Testing:** Add unit/integration tests for the new dependency-aware calculations (`calculateAverageCollectionTime`, refined `simulateMonthlyCaseFlow` **including capacity constraints**).

## Active Decisions & Considerations

*   **MUI Grid Issue:** Continue using the `Box` with flexbox workaround for layout instead of `Grid`.
*   **Formik Integration:** Continue using manual connection for Formik and standard MUI components.
*   **Calculation Complexity:** Financial calculations (detailed CF/P&L considering dependencies/timing) require careful implementation. **Labor cost now includes efficiency.** IRR calculation implemented and annualized. Cost date ranges and basic monthly distributions (cost separation) are now considered in CF. Depreciation period is now configurable. **Recovery rate calculation now uses a simulation based on stage probabilities (recovery/write-off) and dependencies.** **Average collection time calculation now uses a simulation based on stage dependencies, durations, and probabilities.** **Cash Flow income distribution uses a time-based simulation considering stage durations and probabilities.** **Cash Flow variable labor cost distribution now uses the time-based simulation and is proportional to monthly work completion.** All simulations use simplified equal distribution for multiple subsequent stages. (Variable *other* costs are not yet included in the monthly simulation). **Capacity calculation is based on total available monthly hours; workload calculation uses efficiency-adjusted normative times.** **The impact of capacity constraints (utilization > 100%) on actual throughput/cost IS NOW MODELED in the `simulateMonthlyCaseFlow` simulation by slowing down case progression.**
*   **Visualization Implementation:** Requires choosing appropriate chart types and structuring data for Recharts. **Workflow visualization (`WorkflowVisualizer.tsx`) refactored to a vertical layout showing stages, durations, colored probabilities, and substages.** **Labor cost display now includes capacity/workload/utilization.** Dashboard charts (`KeyCharts`) are basic and need refinement.
*   **State Management for Scenarios:** **Scenarios now save/load the full relevant state (staff, stages, costs, financials, caseload).** Comparison UI still needs implementation.
