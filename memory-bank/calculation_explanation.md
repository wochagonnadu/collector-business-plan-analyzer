# Объяснение Расчетов в Collector Business Plan Analyzer

Этот документ описывает основные функции расчетов, используемые в приложении, их назначение и расположение в коде.

## 1. Расчеты Трудозатрат

Эти функции отвечают за расчет стоимости работы персонала на основе этапов взыскания и распределения дел.

### `calculateHourlyRate(salary, workingHours)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает стоимость одного часа работы сотрудника.
*   **Логика:** Делит месячный оклад (`salary`) на количество рабочих часов в месяц (`workingHours`). Возвращает 0, если часы некорректны.

### `calculateSubStageExecutionCost(subStage, staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает стоимость одного выполнения конкретного подэтапа (`subStage`) одним сотрудником.
*   **Логика:**
    *   Находит сотрудника (`executor`) по должности, указанной в подэтапе.
    *   Рассчитывает часовую ставку (`hourlyRate`) этого сотрудника с помощью `calculateHourlyRate`.
    *   Определяет эффективное время выполнения подэтапа в часах, деля нормативное время (в минутах) на 60 и на коэффициент эффективности сотрудника (`efficiencyFactor`).
    *   Умножает эффективное время на часовую ставку.
    *   Возвращает 0, если исполнитель не найден.

### `distributeCases(totalCases, distributionPercentages)`
*   **Файл:** `src/utils/laborCostCalculations.ts`
*   **Назначение:** Распределяет общее количество дел (`totalCases`) по начальным этапам взыскания согласно заданным процентным соотношениям (`distributionPercentages`).
*   **Логика:**
    *   Рассчитывает количество дел для каждого этапа пропорционально его проценту.
    *   Округляет результат до целого числа дел.
    *   Корректирует возможное расхождение из-за округления, добавляя/вычитая разницу к первому этапу.

### `calculateAnnualCaseloadLaborCost(state)`
*   **Файл:** `src/utils/laborCostCalculations.ts`
*   **Назначение:** Рассчитывает общие *переменные* годовые трудозатраты, основанные на распределении дел по этапам (caseload).
*   **Логика:**
    *   Получает необходимые данные из `state` (staff, stages, financials).
    *   Распределяет общее количество дел по этапам с помощью `distributeCases`.
    *   Для каждого этапа и каждого подэтапа внутри него:
        *   Рассчитывает стоимость одного выполнения подэтапа с помощью `calculateSubStageExecutionCost`.
        *   Умножает эту стоимость на количество дел на данном этапе и на количество повторений подэтапа (`subStage.repetitions`).
    *   Суммирует затраты по всем подэтапам и этапам.
    *   Возвращает 0, если данных недостаточно.
    *   **Примечание:** Эта функция рассчитывает только *переменные* трудозатраты, зависящие от количества дел и сложности этапов. Фиксированные оклады рассчитываются отдельно (например, в `generateCashFlow`).

## 2. Расчеты Финансовых Отчетов

Эти функции генерируют основные финансовые отчеты: Cash Flow (Движение денежных средств) и P&L (Отчет о прибылях и убытках).

### `generateCashFlow(state)`
*   **Файл:** `src/utils/financialStatementCalculations.ts`
*   **Назначение:** Генерирует годовой отчет о движении денежных средств (Cash Flow) с разбивкой по месяцам.
*   **Логика:**
    *   Рассчитывает ежемесячные *фиксированные* трудозатраты (оклады всех сотрудников).
    *   Рассчитывает прочие затраты по месяцам (операционные, капитальные), распределяя их по периоду (ежемесячно, ежеквартально и т.д.). **TODO:** Учесть даты начала/окончания затрат.
    *   Рассчитывает ежемесячные *переменные* трудозатраты, распределяя годовую сумму (`calculateAnnualCaseloadLaborCost`) равномерно по 12 месяцам. **TODO:** Улучшить распределение на основе симуляции потока дел.
    *   Рассчитывает ежемесячный доход (Inflow), распределяя общий ожидаемый доход (на основе портфеля и вероятностей взыскания) равномерно по максимальному сроку взыскания (`calculateMaxCollectionTime`). **TODO:** Улучшить симуляцию дохода на основе зависимостей этапов.
    *   Для каждого месяца рассчитывает: общий отток (сумма всех затрат), чистый поток (приток - отток) и накопленный поток.
    *   Возвращает массив данных `MonthlyCashFlow` за 12 месяцев.

### `generatePnL(state)`
*   **Файл:** `src/utils/financialStatementCalculations.ts`
*   **Назначение:** Генерирует годовой отчет о прибылях и убытках (P&L).
*   **Логика:**
    *   Вызывает `generateCashFlow` для получения данных по доходам и расходам за год.
    *   Суммирует годовые показатели: общая выручка, общие фиксированные трудозатраты, общие переменные трудозатраты, общие прочие затраты. **TODO:** Разделить прочие затраты на операционные и капитальные для P&L.
    *   Рассчитывает общие операционные затраты.
    *   Рассчитывает прибыль до налогообложения (Выручка - Общие операционные затраты).
    *   Рассчитывает сумму налога на основе ставки (`taxRate`) и прибыли (если она положительная).
    *   Рассчитывает чистую прибыль (Прибыль до налогов - Налог).
    *   Возвращает объект `PnLData`.

## 3. Расчеты Метрик Процесса и Эффективности

Эти функции рассчитывают ключевые показатели, связанные с процессом взыскания.

### `calculateMaxCollectionTime(state)`
*   **Файл:** `src/utils/processCalculations.ts`
*   **Назначение:** Рассчитывает максимальный срок взыскания в днях, анализируя граф зависимостей между этапами (`dependsOn`). Находит самый длинный (критический) путь от начальных до конечных этапов.
*   **Логика:**
    *   Использует вспомогательную рекурсивную функцию `findLongestPathDuration` с мемоизацией для обхода графа зависимостей и обнаружения циклов.
    *   Находит все "конечные" этапы (те, от которых другие не зависят).
    *   Для каждого конечного этапа рекурсивно рассчитывает максимальную длительность пути до него, суммируя максимальные длительности (`durationDays.max`) этапов на пути.
    *   Возвращает максимальную из найденных длительностей путей.
    *   Возвращает `Infinity`, если обнаружен цикл в зависимостях.

### `calculateOverallRecoveryRate(state)`
*   **Файл:** `src/utils/processCalculations.ts`
*   **Назначение:** Рассчитывает общий (суммарный) процент успешного взыскания.
*   **Логика:** Просто суммирует вероятности успешного взыскания (`recoveryProbability`), заданные для портфеля долгов (досудебное, судебное, исполнительное, банкротство). **TODO:** Усложнить расчет с учетом реальных переходов между этапами.

### `calculateCostPerCase(state, pnlData)`
*   **Файл:** `src/utils/processCalculations.ts`
*   **Назначение:** Рассчитывает среднюю стоимость взыскания одного *успешно* завершенного дела.
*   **Логика:**
    *   Рассчитывает долю успешно взысканных дел (`calculateOverallRecoveryRate`).
    *   Рассчитывает абсолютное количество успешно взысканных дел (Общее кол-во дел * Доля успеха).
    *   Делит общие операционные затраты (из `pnlData.totalCosts`) на количество успешно взысканных дел.
    *   Возвращает `Infinity`, если нет успешно взысканных дел.

---
*Примечание: Некоторые расчеты (особенно связанные с распределением дохода, переменных затрат и вероятностями) используют упрощенные модели. В комментариях к коду (`// TODO:`) отмечены места для возможного усложнения и повышения точности симуляции.*
