# Объяснение Расчетов в Collector Business Plan Analyzer

Этот документ описывает основные функции расчетов, используемые в приложении, их назначение, расположение в коде и влияние различных параметров на результат. Эти расчеты лежат в основе метрик, отображаемых на **Панели управления (Dashboard)** и используются на страницах конфигурации.

## 1. Расчеты Трудозатрат и Производительности

Эти функции являются основой для расчета переменных затрат и оценки выполнимости плана с точки зрения персонала.

### `calculateHourlyRate(salary, workingHours)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает стоимость одного часа работы сотрудника. Используется для определения стоимости выполнения подэтапов.
*   **Логика:** Делит месячный оклад (`salary`) на количество рабочих часов в месяц (`workingHours`).
*   **Влияющие параметры:** Оклад сотрудника, Рабочие часы в месяц (из модуля Staff Management).

### `calculateSubStageEffectiveHours(subStage, staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает *эффективное* время (в часах), необходимое для выполнения подэтапа одним сотрудником, с учетом его производительности. Используется в симуляции для определения рабочей нагрузки.
*   **Логика:** Находит сотрудника по должности, делит нормативное время подэтапа (в минутах) на 60 и на процент эффективности сотрудника (`efficiencyPercent` / 100).
*   **Влияющие параметры:** Нормативное время подэтапа (из модуля Collection Stages), Должность исполнителя (из модуля Collection Stages), Эффективность сотрудника (из модуля Staff Management).

### `calculateSubStageExecutionCost(subStage, staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает *переменную* стоимость одного выполнения конкретного подэтапа (`subStage`) одним сотрудником с учетом его эффективности. Используется в симуляции для расчета переменных трудозатрат.
*   **Логика:** Умножает эффективное время выполнения (`calculateSubStageEffectiveHours`) на часовую ставку сотрудника (`calculateHourlyRate`).
*   **Влияющие параметры:** Нормативное время подэтапа, Должность исполнителя, Эффективность сотрудника, Оклад сотрудника, Рабочие часы в месяц.

### `calculateAvailableMonthlyWorkHours(staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает общее количество доступных рабочих часов *всего* персонала в месяц. Используется в симуляции для определения ограничения по производительности (capacity).
*   **Логика:** Суммирует рабочие часы (`workingHours`) всех сотрудников (`staffList`).
*   **Влияющие параметры:** Количество сотрудников, Рабочие часы в месяц для каждого сотрудника.

### `calculateRequiredAnnualWorkloadHours(state)`
*   **Файл:** `src/utils/laborCostCalculations.ts`
*   **Назначение:** Рассчитывает *требуемую* годовую рабочую нагрузку в часах для обработки всего портфеля дел с учетом эффективности персонала. Используется для расчета утилизации.
*   **Логика:**
    *   Распределяет дела (`distributeCases`).
    *   Для каждого подэтапа умножает количество дел на этапе на количество повторений подэтапа и на *эффективное* время выполнения (`calculateSubStageEffectiveHours`).
    *   Суммирует часы по всем подэтапам.
*   **Влияющие параметры:** Объем портфеля (из Debt Portfolio Config), Распределение дел по этапам (из Caseload Distribution), Структура этапов/подэтапов (Нормативное время, Повторения, Исполнитель), Эффективность персонала.

### `LaborCostDisplay` (Компонент)
*   **Файл:** `src/components/LaborCost/LaborCostDisplay.tsx`
*   **Отображаемые метрики:**
    *   **Фиксированные годовые трудозатраты:** Сумма годовых окладов всего персонала.
    *   **Переменные годовые трудозатраты:** Рассчитываются на основе симуляции `simulateMonthlyCaseFlow` (см. раздел 4), суммируя стоимость выполнения всех подэтапов для всех дел за год.
    *   **Общие годовые трудозатраты:** Сумма фиксированных и переменных.
    *   **Требуемая годовая нагрузка (часы):** Результат `calculateRequiredAnnualWorkloadHours`.
    *   **Доступная годовая емкость (часы):** Результат `calculateAvailableMonthlyWorkHours` * 12.
    *   **Утилизация (%):** (Требуемая нагрузка / Доступная емкость) * 100%. Показывает, насколько загружен персонал. Значение > 100% означает нехватку ресурсов, что учитывается в симуляции `simulateMonthlyCaseFlow` через замедление прогресса дел.

## 2. Метрики Процесса Взыскания (Dashboard)

Эти метрики отражают эффективность самого процесса сбора долгов.

### `calculateAverageCollectionTime(state)`
*   **Файл:** `src/utils/processCalculations/averageCollectionTime.ts` (вызывается из `index.ts`)
*   **Назначение:** Рассчитывает средневзвешенное время (в днях) от поступления дела до его успешного завершения (взыскания).
*   **Логика:**
    *   Использует симуляцию (поиск в ширину - BFS) для обхода графа зависимостей этапов (`nextStageIds`).
    *   Учитывает вероятности перехода между этапами (`transitionProbability`), вероятности успешного взыскания (`recoveryProbability`) и списания (`writeOffProbability`) на каждом этапе.
    *   Суммирует максимальные длительности (`durationDays.max`) этапов на каждом *успешном* пути, взвешивая их по вероятности прохождения этого пути.
    *   Рассчитывает среднее взвешенное время по всем успешным путям.
*   **Влияющие параметры:** Структура этапов (Зависимости `nextStageIds`, Длительности `durationDays.max`), Вероятности переходов, взыскания и списания (из Stage Probabilities Config).

### `calculateOverallRecoveryRate(state)`
*   **Файл:** `src/utils/processCalculations/recoveryRateSimulation.ts` (вызывается из `index.ts`)
*   **Назначение:** Рассчитывает общий процент успешно взысканных дел от общего объема портфеля.
*   **Логика:**
    *   Использует симуляцию (`simulateCaseFlowAndRecovery`, поиск в ширину - BFS) для моделирования потока дел по графу зависимостей (`nextStageIds`).
    *   На каждом этапе учитывает вероятности успешного взыскания (`recoveryProbability`), списания (`writeOffProbability`) и перехода к следующим этапам (`transitionProbability`).
    *   Суммирует доли дел, успешно взысканных на *каждом* этапе.
*   **Влияющие параметры:** Структура этапов (Зависимости `nextStageIds`), Вероятности взыскания, списания и переходов (из Stage Probabilities Config), Распределение дел по начальным этапам (из Caseload Distribution).

### `calculateCostPerCase(state)`
*   **Файл:** `src/utils/processCalculations/costPerCase.ts` (вызывается из `index.ts`)
*   **Назначение:** Рассчитывает среднюю *операционную* стоимость взыскания одного *успешно* завершенного дела.
*   **Логика:**
    *   Рассчитывает общее количество успешно взысканных дел (Общий объем портфеля * `calculateOverallRecoveryRate`).
    *   Рассчитывает общие годовые операционные затраты (сумма годовых фиксированных и переменных трудозатрат + годовые прочие операционные расходы из модуля Costs).
    *   Делит общие годовые операционные затраты на количество успешно взысканных дел.
*   **Влияющие параметры:** Все параметры, влияющие на `calculateOverallRecoveryRate`, Трудозатраты (Фиксированные и Переменные), Прочие операционные расходы (из модуля Costs), Объем портфеля.

## 3. Финансовые Метрики (Dashboard)

Эти метрики оценивают финансовую привлекательность и устойчивость бизнес-плана.

### `calculateBreakEven(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает точку безубыточности - количество дел, которое необходимо успешно взыскать за год, чтобы покрыть все годовые операционные затраты.
*   **Логика:**
    *   Рассчитывает общие годовые фиксированные операционные затраты (Фиксированные трудозатраты + Фиксированные прочие операционные расходы).
    *   Рассчитывает средний доход с одного успешно взысканного дела (Средняя сумма долга * Процент комиссии).
    *   Рассчитывает переменные затраты на одно успешно взысканное дело (Переменные трудозатраты на дело + Переменные прочие операционные расходы на дело).
    *   Рассчитывает маржу на одно дело (Средний доход - Переменные затраты на дело).
    *   Делит общие фиксированные затраты на маржу на одно дело.
*   **Влияющие параметры:** Оклады персонала, Фиксированные операционные расходы, Средняя сумма долга, Процент комиссии (из Financial Params), Переменные трудозатраты (зависят от этапов, эффективности), Переменные операционные расходы.

### `calculateNPV(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает чистую приведенную стоимость (Net Present Value) - разницу между приведенной стоимостью будущих денежных потоков и первоначальными инвестициями за весь период планирования. Показывает абсолютную прибыльность проекта с учетом стоимости денег во времени.
*   **Логика:**
    *   Использует годовой чистый денежный поток (Net Cash Flow) из `generateCashFlow`.
    *   Дисконтирует каждый годовой поток к текущему моменту, используя ставку дисконтирования (`discountRate`). Формула дисконтирования: `Поток_года_N / (1 + Ставка_дисконтирования)^N`.
    *   Суммирует дисконтированные потоки.
    *   Вычитает первоначальные инвестиции (капитальные затраты первого года).
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow`, Ставка дисконтирования (из Financial Params).

### `calculateIRR(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает внутреннюю норму доходности (Internal Rate of Return) - ставку дисконтирования, при которой NPV проекта равен нулю. Показывает относительную доходность проекта в процентах годовых.
*   **Логика:**
    *   Использует годовой чистый денежный поток (Net Cash Flow) из `generateCashFlow`.
    *   Использует внешнюю библиотеку `irr` для итеративного подбора ставки, при которой сумма дисконтированных потоков (включая первоначальные инвестиции как отрицательный поток в году 0) равна нулю.
    *   Результат возвращается в виде годового процента.
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow`.

### `calculateEBITDA(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает прибыль до вычета процентов, налогов, износа и амортизации (Earnings Before Interest, Taxes, Depreciation, and Amortization). Показывает операционную прибыльность компании без учета структуры капитала и налоговой нагрузки.
*   **Логика:**
    *   Берет Прибыль до налогообложения (EBT) из `generatePnL`.
    *   Рассчитывает годовую амортизацию: делит общие капитальные затраты (из модуля Costs) на срок амортизации (`depreciationPeriodYears`).
    *   Добавляет рассчитанную амортизацию к EBT. (Проценты по кредитам пока не учитываются).
*   **Влияющие параметры:** Все параметры, влияющие на `generatePnL`, Капитальные затраты (из модуля Costs), Срок амортизации (из Financial Params).

## 4. Финансовые Отчеты (Основа для Dashboard Charts)

### `generateCashFlow(state)`
*   **Файл:** `src/utils/cashFlowCalculations.ts` (использует `monthlySimulation.ts`)
*   **Назначение:** Генерирует годовой отчет о движении денежных средств (Cash Flow) с разбивкой по месяцам. Используется для расчета NPV, IRR и для построения графика CF на Dashboard.
*   **Логика:**
    *   **Симуляция (`simulateMonthlyCaseFlow`):** Моделирует поток дел месяц за месяцем на основе длительностей этапов (`durationDays.max`), вероятностей переходов/взыскания/списания и зависимостей (`nextStageIds`).
    *   **Учет мощности (`Capacity Constraint`):** Рассчитывает доступные (`calculateAvailableMonthlyWorkHours`) и требуемые (на основе активных дел и `calculateSubStageEffectiveHours`) рабочие часы в месяц. Если требуемые часы > доступных, прогресс дел в симуляции замедляется (`capacityFactor`), реалистично сдвигая доходы и переменные затраты во времени.
    *   **Распределение дохода (Inflow):** Доход от взыскания распределяется по месяцам согласно симуляции (когда дела успешно завершаются).
    *   **Распределение переменных трудозатрат:** Затраты распределяются по месяцам пропорционально объему работы (в эффективных часах), выполненной в симуляции в данном месяце.
    *   **Фиксированные затраты:** Оклады персонала и прочие операционные/капитальные расходы (из модуля Costs) распределяются по месяцам согласно их периодичности.
    *   **Расчет потоков:** Для каждого месяца рассчитывается: общий приток, общий отток (сумма всех затрат), чистый поток (приток - отток) и накопленный поток.
*   **Влияющие параметры:** Практически все параметры системы: Структура этапов (Длительность, Зависимости, Вероятности), Персонал (Количество, Оклады, Часы, Эффективность), Портфель (Объем, Средний долг, Комиссия), Прочие расходы (Суммы, Периодичность), Финансовые параметры (Ставка налога, Ставка дисконтирования).

### `generatePnL(state)`
*   **Файл:** `src/utils/pnlCalculations.ts`
*   **Назначение:** Генерирует годовой отчет о прибылях и убытках (P&L). Используется для расчета EBITDA и для построения графика P&L на Dashboard.
*   **Логика:**
    *   Суммирует годовые показатели из `generateCashFlow`: общая выручка (Inflow), общие фиксированные трудозатраты, общие переменные трудозатраты, общие прочие операционные расходы.
    *   Рассчитывает общие операционные затраты.
    *   Рассчитывает прибыль до налогообложения (Выручка - Общие операционные затраты).
    *   Рассчитывает сумму налога на основе ставки (`taxRate`).
    *   Рассчитывает чистую прибыль.
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow`, Ставка налога (из Financial Params).

---

## 5. Расчеты и Данные на Страницах Конфигурации

### Страница "Staff Management" (`StaffManagementPage.tsx`)
*   **Основные вводы:** Должность, Группа, Оклад (`salary`), Рабочие часы в месяц (`workingHours`), Процент эффективности (`efficiencyPercent`), Макс. кол-во дел (`maxCaseload` - *пока не используется в расчетах*).
*   **Прямые расчеты на странице:** Нет.
*   **Влияние на систему:**
    *   `salary` и `workingHours` используются в `calculateHourlyRate` (Раздел 1).
    *   `efficiencyPercent` используется в `calculateSubStageEffectiveHours` и `calculateSubStageExecutionCost` (Раздел 1).
    *   `workingHours` и количество сотрудников влияют на `calculateAvailableMonthlyWorkHours` (Раздел 1).
    *   Оклады (`salary`) напрямую учитываются как фиксированные трудозатраты в `generateCashFlow` (Раздел 4).

### Страница "Collection Stages" (`CollectionStagesPage.tsx`)
*   **Основные вводы:**
    *   **Этапы:** Название, Длительность (мин/макс дни - `durationDays`), Зависимости (`nextStageIds`).
    *   **Подэтапы:** Название, Нормативное время (мин - `normativeTimeMinutes`), Количество повторений (`repetitions`), Должность исполнителя (`executorPosition`).
*   **Прямые расчеты/визуализации на странице:**
    *   `WorkflowVisualizer`: Отображает граф зависимостей (`nextStageIds`) между этапами.
*   **Влияние на систему:**
    *   `durationDays.max` используется в симуляциях `calculateAverageCollectionTime` и `simulateMonthlyCaseFlow` (Разделы 2, 4).
    *   `nextStageIds` определяют структуру графа для всех симуляций (`calculateAverageCollectionTime`, `calculateOverallRecoveryRate`, `simulateMonthlyCaseFlow`) (Разделы 2, 4).
    *   `normativeTimeMinutes` и `executorPosition` используются в `calculateSubStageEffectiveHours` и `calculateSubStageExecutionCost` (Раздел 1).
    *   `repetitions` и `normativeTimeMinutes` влияют на расчет требуемой нагрузки `calculateRequiredAnnualWorkloadHours` (Раздел 1).

### Страница "Costs" (`CostsPage.tsx`)
*   **Основные вводы:** Название, Сумма (`amount`), Периодичность (`periodicity`), Тип (`type` - Capital/Operational), Тег (`tag`), Даты начала/окончания (*пока не используются*).
*   **Прямые расчеты на странице:** Нет.
*   **Влияние на систему:**
    *   Затраты типа `Operational` суммируются (с учетом `periodicity`) и включаются в операционные расходы в `generatePnL` и `generateCashFlow` (Раздел 4). Они также влияют на `calculateCostPerCase` и `calculateBreakEven` (Разделы 2, 3).
    *   Затраты типа `Capital` суммируются и используются для расчета амортизации в `calculateEBITDA` (Раздел 3) и как первоначальные инвестиции (отток) в `generateCashFlow` (Раздел 4) и `calculateNPV` (Раздел 3).

### Страница "Financial Modeling" (`FinancialModelingPage.tsx`)
*   **Основные вводы:**
    *   `DebtPortfolioConfig`: Общее кол-во дел (`totalCases`), Средняя сумма долга (`averageDebtAmount`), Процент комиссии (`commissionRate`).
    *   `FinancialParamsConfig`: Ставка дисконтирования (`discountRate`), Ставка налога (`taxRate`), Срок амортизации (`depreciationPeriodYears`).
    *   `StageProbabilitiesConfig`: Вероятности Взыскания (`recoveryProbability`), Списания (`writeOffProbability`), Перехода (`transitionProbability`) для каждого этапа.
    *   `CaseloadDistributionConfig`: Процентное распределение дел по начальным этапам.
*   **Прямые расчеты/визуализации на странице:**
    *   `FinancialReport`: Отображает таблицы Cash Flow и P&L (результаты `generateCashFlow`, `generatePnL`).
    *   `TimelineVisualizer`: Строит график накопленного Cash Flow (из `generateCashFlow`).
    *   `LaborCostDisplay`: Отображает метрики трудозатрат и утилизации (см. Раздел 1).
    *   `DistributionVisualizer`: Отображает диаграмму распределения дел по этапам.
*   **Влияние на систему:**
    *   `totalCases`, `averageDebtAmount`, `commissionRate` напрямую влияют на расчет выручки в `generateCashFlow`, `generatePnL` и на `calculateBreakEven` (Разделы 3, 4). `totalCases` используется в `distributeCases`.
    *   `discountRate` используется в `calculateNPV` (Раздел 3).
    *   `taxRate` используется в `generatePnL` (Раздел 4).
    *   `depreciationPeriodYears` используется в `calculateEBITDA` (Раздел 3).
    *   Вероятности из `StageProbabilitiesConfig` являются ключевыми для симуляций `calculateAverageCollectionTime`, `calculateOverallRecoveryRate`, `simulateMonthlyCaseFlow` (Разделы 2, 4).
    *   Проценты из `CaseloadDistributionConfig` используются в `distributeCases`, влияя на `calculateRequiredAnnualWorkloadHours` и определяя стартовые точки для симуляций (Разделы 1, 2, 4).

---
*Примечание: Симуляции (`simulateMonthlyCaseFlow`, `simulateCaseFlowAndRecovery`, `calculateAverageCollectionTime`) используют упрощенное равномерное распределение при наличии нескольких следующих этапов (ветвление).*
