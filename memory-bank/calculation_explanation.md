# Объяснение Расчетов в Collector Business Plan Analyzer

Этот документ описывает основные функции расчетов, используемые в приложении, их назначение, расположение в коде и влияние различных параметров на результат. Эти расчеты лежат в основе метрик, отображаемых на **Панели управления (Dashboard)** и используются на страницах конфигурации.

## 1. Расчеты Трудозатрат и Производительности

Эти функции являются основой для расчета переменных затрат и оценки выполнимости плана с точки зрения персонала.

### `calculateHourlyRate(salary, workingHours)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает стоимость одного часа работы сотрудника. // Рассчитывает стоимость одного часа работы сотрудника.
*   **Использование:** Используется для определения стоимости выполнения подэтапов.
*   **Логика:** Делит месячный оклад (`salary`) на количество рабочих часов в месяц (`workingHours`). // Деление оклада на часы.
*   **Влияющие параметры:** Оклад сотрудника, Рабочие часы в месяц (из модуля Staff Management).

### `calculateSubStageEffectiveHours(subStage, staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает *эффективное* время (в часах), необходимое для выполнения подэтапа одним сотрудником, с учетом его производительности. // Расчет времени с поправкой на эффективность.
*   **Использование:** Используется в симуляции `simulateMonthlyCaseFlow` для определения фактической рабочей нагрузки и в `calculateRequiredAnnualWorkloadHours`.
*   **Логика:** Находит сотрудника по должности, делит нормативное время подэтапа (в минутах) на 60 и на процент эффективности сотрудника (`efficiencyPercent` / 100). // Нормативное время / (60 * (Эффективность / 100)).
*   **Влияющие параметры:** Нормативное время подэтапа (из модуля Collection Stages), Должность исполнителя (из модуля Collection Stages), Эффективность сотрудника (`efficiencyPercent`) (из модуля Staff Management).

### `calculateSubStageExecutionCost(subStage, staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает *переменную* стоимость одного выполнения конкретного подэтапа (`subStage`) одним сотрудником с учетом его эффективности. // Расчет стоимости выполнения подэтапа с учетом эффективности.
*   **Использование:** Используется в симуляции `simulateMonthlyCaseFlow` для расчета переменных трудозатрат.
*   **Логика:** Умножает эффективное время выполнения (`calculateSubStageEffectiveHours`) на часовую ставку сотрудника (`calculateHourlyRate`). // Эффективное время * Часовая ставка.
*   **Влияющие параметры:** Нормативное время подэтапа, Должность исполнителя, Эффективность сотрудника (`efficiencyPercent`), Оклад сотрудника, Рабочие часы в месяц.

### `calculateAvailableMonthlyWorkHours(staffList)`
*   **Файл:** `src/utils/staffCalculations.ts`
*   **Назначение:** Рассчитывает общее количество доступных рабочих часов *всего* персонала в месяц. // Суммарная месячная емкость персонала.
*   **Использование:** Используется в симуляции `simulateMonthlyCaseFlow` для определения ограничения по производительности (capacity).
*   **Логика:** Суммирует рабочие часы (`workingHours`) всех сотрудников (`staffList`). // Сумма `workingHours` по всем сотрудникам.
*   **Влияющие параметры:** Количество сотрудников, Рабочие часы в месяц для каждого сотрудника.

### `calculateRequiredAnnualWorkloadHours(state)`
*   **Файл:** `src/utils/laborCostCalculations.ts`
*   **Назначение:** Рассчитывает *требуемую* годовую рабочую нагрузку в *эффективных* часах для обработки всего портфеля дел. // Расчет годовой потребности в рабочих часах с учетом эффективности.
*   **Использование:** Используется для расчета утилизации персонала в `LaborCostDisplay`.
*   **Логика:**
    *   Распределяет дела по начальным этапам (`distributeCases`). // Распределение портфеля.
    *   Для каждого подэтапа: умножает количество дел на этапе на количество повторений подэтапа (`repetitions`) и на *эффективное* время выполнения этого подэтапа (`calculateSubStageEffectiveHours`). // Суммирование эффективных часов = (Кол-во дел * Повторения * Эффективное время) по всем подэтапам.
    *   Суммирует эффективные часы по всем подэтапам всех этапов.
*   **Влияющие параметры:** Объем портфеля (из Debt Portfolio Config), Распределение дел по этапам (из Caseload Distribution), Структура этапов/подэтапов (Нормативное время, Повторения, Исполнитель), Эффективность персонала (`efficiencyPercent`).

### `LaborCostDisplay` (Компонент)
*   **Файл:** `src/components/LaborCost/LaborCostDisplay.tsx`
*   **Отображаемые метрики:**
    *   **Фиксированные годовые трудозатраты:** Сумма годовых окладов всего персонала. // Сумма годовых окладов.
    *   **Переменные годовые трудозатраты:** Рассчитываются на основе симуляции `simulateMonthlyCaseFlow` (см. раздел 4), суммируя стоимость выполнения всех подэтапов для всех дел за год. // Сумма стоимости всех подэтапов за год из симуляции.
    *   **Общие годовые трудозатраты:** Сумма фиксированных и переменных. // Итого трудозатраты.
    *   **Требуемая годовая нагрузка (эффективные часы):** Результат `calculateRequiredAnnualWorkloadHours`. // Потребность в эффективных часах.
    *   **Доступная годовая емкость (часы):** Результат `calculateAvailableMonthlyWorkHours` * 12. // Доступные часы персонала.
    *   **Утилизация (%):** (Требуемая нагрузка / Доступная емкость) * 100%. Показывает, насколько загружен персонал. // Процент загрузки. **Важно:** Значение > 100% означает нехватку ресурсов, что **моделируется** в симуляции `simulateMonthlyCaseFlow` через замедление прогресса дел (`capacityFactor`).

## 2. Метрики Процесса Взыскания (Dashboard)

Эти метрики отражают эффективность самого процесса сбора долгов. Рассчитываются в `src/utils/processCalculations/index.ts`, используя вспомогательные функции.

### `calculateAverageCollectionTime(state)`
*   **Файл:** `src/utils/processCalculations/averageCollectionTime.ts`
*   **Назначение:** Рассчитывает средневзвешенное время (в днях) от поступления дела до его успешного завершения (взыскания). // Среднее время до успешного взыскания.
*   **Логика:**
    *   Использует симуляцию (поиск в ширину - BFS) для обхода графа зависимостей этапов (`nextStageIds`). // Обход графа этапов.
    *   Учитывает вероятности перехода между этапами (`transitionProbability`), вероятности успешного взыскания (`recoveryProbability`) и списания (`writeOffProbability`) на каждом этапе. // Учет вероятностей.
    *   Суммирует максимальные длительности (`durationDays.max`) этапов на каждом *успешном* пути, взвешивая их по вероятности прохождения этого пути. // Суммирование взвешенных длительностей успешных путей.
    *   Рассчитывает среднее взвешенное время по всем успешным путям. // Финальный расчет среднего.
*   **Влияющие параметры:** Структура этапов (Зависимости `nextStageIds`, Длительности `durationDays.max`), Вероятности переходов, взыскания и списания (из Stage Probabilities Config).

### `calculateOverallRecoveryRate(state)`
*   **Файл:** `src/utils/processCalculations/recoveryRateSimulation.ts`
*   **Назначение:** Рассчитывает общий процент успешно взысканных дел от общего объема портфеля. // Общий процент взыскания.
*   **Логика:**
    *   Использует симуляцию (`simulateCaseFlowAndRecovery`, поиск в ширину - BFS) для моделирования потока дел по графу зависимостей (`nextStageIds`). // Моделирование потока дел через граф.
    *   На каждом этапе учитывает вероятности успешного взыскания (`recoveryProbability`), списания (`writeOffProbability`) и перехода к следующим этапам (`transitionProbability`). // Учет вероятностей на каждом шаге.
    *   Суммирует доли дел, успешно взысканных на *каждом* этапе. // Суммирование долей взысканных дел.
*   **Влияющие параметры:** Структура этапов (Зависимости `nextStageIds`), Вероятности взыскания (`recoveryProbability`), списания (`writeOffProbability`) и переходов (`transitionProbability`) (из Stage Probabilities Config), Распределение дел по начальным этапам (из Caseload Distribution).

### `calculateCostPerCase(state)`
*   **Файл:** `src/utils/processCalculations/costPerCase.ts`
*   **Назначение:** Рассчитывает среднюю *операционную* стоимость взыскания одного *успешно* завершенного дела. // Средняя стоимость одного взысканного дела.
*   **Логика:**
    *   Рассчитывает общее количество успешно взысканных дел (Общий объем портфеля * `calculateOverallRecoveryRate`). // Кол-во успешных дел = Объем * Общий % взыскания.
    *   Рассчитывает общие годовые операционные затраты (сумма годовых фиксированных и переменных трудозатрат + годовые прочие операционные расходы из модуля Costs). // Сумма всех годовых операционных затрат.
    *   Делит общие годовые операционные затраты на количество успешно взысканных дел. // Стоимость = Затраты / Кол-во успешных дел.
*   **Влияющие параметры:** Все параметры, влияющие на `calculateOverallRecoveryRate`, Трудозатраты (Фиксированные и Переменные), Прочие операционные расходы (из модуля Costs), Объем портфеля.

## 3. Финансовые Метрики (Dashboard)

Эти метрики оценивают финансовую привлекательность и устойчивость бизнес-плана.

### `calculateBreakEven(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает точку безубыточности - количество дел, которое необходимо успешно взыскать за год, чтобы покрыть все годовые операционные затраты.
*   **Логика:**
    *   Рассчитывает общие годовые фиксированные операционные затраты (Фиксированные трудозатраты + Фиксированные прочие операционные расходы).
    *   Рассчитывает средний доход с одного успешно взысканного дела (Средняя сумма долга * Процент комиссии).
    *   Рассчитывает переменные затраты на одно успешно взысканное дело (Переменные трудозатраты на дело + Переменные прочие операционные расходы на дело).
    *   Рассчитывает маржу на одно дело (Средний доход - Переменные затраты на дело).
    *   Делит общие фиксированные затраты на маржу на одно дело.
*   **Влияющие параметры:** Оклады персонала, Фиксированные операционные расходы, Средняя сумма долга, Процент комиссии (из Financial Params), Переменные трудозатраты (зависят от этапов, эффективности), Переменные операционные расходы.

### `calculateNPV(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает чистую приведенную стоимость (Net Present Value) - разницу между приведенной стоимостью будущих денежных потоков и первоначальными инвестициями за весь период планирования. Показывает абсолютную прибыльность проекта с учетом стоимости денег во времени.
*   **Логика:**
    *   Использует годовой чистый денежный поток (Net Cash Flow) из `generateCashFlow`.
    *   Дисконтирует каждый годовой поток к текущему моменту, используя ставку дисконтирования (`discountRate`). Формула дисконтирования: `Поток_года_N / (1 + Ставка_дисконтирования)^N`.
    *   Суммирует дисконтированные потоки.
    *   Вычитает первоначальные инвестиции (капитальные затраты первого года).
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow`, Ставка дисконтирования (из Financial Params).

### `calculateIRR(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает внутреннюю норму доходности (Internal Rate of Return) - ставку дисконтирования, при которой NPV проекта равен нулю. Показывает относительную доходность проекта в процентах годовых.
*   **Логика:**
    *   Использует годовой чистый денежный поток (Net Cash Flow) из `generateCashFlow`.
    *   Использует внешнюю библиотеку `irr` для итеративного подбора ставки, при которой сумма дисконтированных потоков (включая первоначальные инвестиции как отрицательный поток в году 0) равна нулю.
    *   Результат возвращается в виде годового процента.
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow`.

### `calculateEBITDA(state)`
*   **Файл:** `src/utils/financialMetricsCalculations.ts`
*   **Назначение:** Рассчитывает прибыль до вычета процентов, налогов, износа и амортизации (Earnings Before Interest, Taxes, Depreciation, and Amortization). // Оценка операционной прибыльности до налогов и амортизации.
*   **Логика:**
    *   Берет Прибыль до налогообложения (EBT) из `generatePnL`. // Получение EBT.
    *   Рассчитывает годовую амортизацию: делит общие капитальные затраты (из модуля Costs) на **конфигурируемый** срок амортизации (`depreciationPeriodYears` из Financial Params). // Расчет амортизации = Кап. затраты / Срок амортизации.
    *   Добавляет рассчитанную амортизацию к EBT. (Проценты по кредитам пока не учитываются). // EBITDA = EBT + Амортизация.
*   **Влияющие параметры:** Все параметры, влияющие на `generatePnL`, Капитальные затраты (из модуля Costs), **Срок амортизации (`depreciationPeriodYears`)** (из Financial Params).

## 4. Финансовые Отчеты (Основа для Dashboard Charts)

### `generateCashFlow(state)`
*   **Файл:** `src/utils/cashFlowCalculations.ts` (использует `src/utils/monthlySimulation.ts`)
*   **Назначение:** Генерирует годовой отчет о движении денежных средств (Cash Flow) с разбивкой по месяцам. // Создание месячного отчета CF.
*   **Использование:** Используется для расчета NPV, IRR и для построения графика CF на Dashboard и в `FinancialReport`, `HorizontalCashflowReport`.
*   **Логика:**
    *   **Месячная Симуляция (`simulateMonthlyCaseFlow`):** Моделирует поток дел месяц за месяцем на основе максимальных длительностей этапов (`durationDays.max`), вероятностей переходов/взыскания/списания и зависимостей (`nextStageIds`). // Симуляция движения дел по месяцам.
    *   **Учет Ограничения Мощности (`Capacity Constraint`):**
        *   Рассчитывает доступные (`calculateAvailableMonthlyWorkHours`) и требуемые (на основе активных дел в симуляции и `calculateSubStageEffectiveHours`) рабочие часы в месяц. // Расчет доступных и требуемых часов.
        *   Если требуемые часы > доступных, прогресс дел в симуляции **замедляется** (через `capacityFactor`), реалистично сдвигая доходы и переменные затраты во времени. // Замедление при перегрузке (>100% утилизации).
    *   **Распределение Дохода (Inflow):** Доход от взыскания (`averageDebtAmount * commissionRate`) распределяется по месяцам согласно симуляции (когда дела успешно завершаются). // Распределение дохода по месяцам симуляции.
    *   **Распределение Переменных Трудозатрат:** Затраты (`calculateSubStageExecutionCost`) распределяются по месяцам **пропорционально объему работы (в эффективных часах)**, выполненной в симуляции в данном месяце. // Распределение переменных трудозатрат пропорционально работе.
    *   **Фиксированные Затраты:** Оклады персонала и прочие операционные/капитальные расходы (из модуля Costs) распределяются по месяцам согласно их периодичности (`periodicity`). // Распределение фиксированных затрат.
    *   **Расчет Потоков:** Для каждого месяца рассчитывается: общий приток (`inflow`), общий отток (`outflow` - сумма всех затрат), чистый поток (`netCashFlow` = приток - отток) и накопленный поток (`cumulativeCashFlow`). // Расчет итоговых потоков за месяц.
*   **Влияющие параметры:** Практически все параметры системы: Структура этапов (Длительность, Зависимости, Вероятности), Персонал (Количество, Оклады, Часы, Эффективность), Портфель (Объем, Средний долг, Комиссия), Прочие расходы (Суммы, Периодичность), Финансовые параметры (Ставка налога, Ставка дисконтирования).

### `generatePnL(state)`
*   **Файл:** `src/utils/pnlCalculations.ts`
*   **Назначение:** Генерирует годовой отчет о прибылях и убытках (P&L). // Создание годового отчета P&L.
*   **Использование:** Используется для расчета EBITDA и для построения графика P&L на Dashboard и в `FinancialReport`.
*   **Логика:**
    *   Суммирует годовые показатели из `generateCashFlow`: общая выручка (`inflow`), общие фиксированные трудозатраты, общие переменные трудозатраты, общие прочие операционные расходы. // Суммирование годовых доходов и расходов из CF.
    *   Рассчитывает общие операционные затраты. // Итого операционные затраты.
    *   Рассчитывает прибыль до налогообложения (EBT = Выручка - Общие операционные затраты). // Расчет EBT.
    *   Рассчитывает сумму налога на основе ставки (`taxRate`). // Расчет налога = EBT * taxRate.
    *   Рассчитывает чистую прибыль (Net Profit = EBT - Налог). // Расчет чистой прибыли.
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow`, Ставка налога (`taxRate`) (из Financial Params).

---

## 5. Расчеты и Данные на Страницах Конфигурации

### Страница "Staff Management" (`StaffManagementPage.tsx`)
*   **Основные вводы:** Должность, Группа, Оклад (`salary`), Рабочие часы в месяц (`workingHours`), Процент эффективности (`efficiencyPercent`), Макс. кол-во дел (`maxCaseload` - *пока не используется в расчетах*).
*   **Прямые расчеты на странице:** Нет.
*   **Влияние на систему:**
    *   `salary` и `workingHours` используются в `calculateHourlyRate` (Раздел 1).
    *   `efficiencyPercent` используется в `calculateSubStageEffectiveHours` и `calculateSubStageExecutionCost` (Раздел 1).
    *   `workingHours` и количество сотрудников влияют на `calculateAvailableMonthlyWorkHours` (Раздел 1).
    *   Оклады (`salary`) напрямую учитываются как фиксированные трудозатраты в `generateCashFlow` (Раздел 4).

### Страница "Collection Stages" (`CollectionStagesPage.tsx`)
*   **Основные вводы:**
    *   **Этапы:** Название, Длительность (мин/макс дни - `durationDays`), Зависимости (`nextStageIds`).
    *   **Подэтапы:** Название, Нормативное время (мин - `normativeTimeMinutes`), Количество повторений (`repetitions`), Должность исполнителя (`executorPosition`).
*   **Прямые расчеты/визуализации на странице:**
    *   `WorkflowVisualizer`: Отображает граф зависимостей (`nextStageIds`) между этапами.
*   **Влияние на систему:**
    *   `durationDays.max` используется в симуляциях `calculateAverageCollectionTime` и `simulateMonthlyCaseFlow` (Разделы 2, 4).
    *   `nextStageIds` определяют структуру графа для всех симуляций (`calculateAverageCollectionTime`, `calculateOverallRecoveryRate`, `simulateMonthlyCaseFlow`) (Разделы 2, 4).
    *   `normativeTimeMinutes` и `executorPosition` используются в `calculateSubStageEffectiveHours` и `calculateSubStageExecutionCost` (Раздел 1).
    *   `repetitions` и `normativeTimeMinutes` влияют на расчет требуемой нагрузки `calculateRequiredAnnualWorkloadHours` (Раздел 1).

### Страница "Costs" (`CostsPage.tsx`)
*   **Основные вводы:** Название, Сумма (`amount`), Периодичность (`periodicity`), Тип (`type` - Capital/Operational), Тег (`tag`), Даты начала/окончания (*пока не используются*).
*   **Прямые расчеты на странице:** Нет.
*   **Влияние на систему:**
    *   Затраты типа `Operational` суммируются (с учетом `periodicity`) и включаются в операционные расходы в `generatePnL` и `generateCashFlow` (Раздел 4). Они также влияют на `calculateCostPerCase` и `calculateBreakEven` (Разделы 2, 3).
    *   Затраты типа `Capital` суммируются и используются для расчета амортизации в `calculateEBITDA` (Раздел 3) и как первоначальные инвестиции (отток) в `generateCashFlow` (Раздел 4) и `calculateNPV` (Раздел 3).

### Страница "Financial Modeling" (`FinancialModelingPage.tsx`)
*   **Основные вводы:**
    *   `DebtPortfolioConfig`: Общее кол-во дел (`totalCases`), Средняя сумма долга (`averageDebtAmount`), Процент комиссии (`commissionRate`).
    *   `FinancialParamsConfig`: Ставка дисконтирования (`discountRate`), Ставка налога (`taxRate`), Срок амортизации (`depreciationPeriodYears`).
    *   `StageProbabilitiesConfig`: Вероятности Взыскания (`recoveryProbability`), Списания (`writeOffProbability`), Перехода (`transitionProbability`) для каждого этапа.
    *   `CaseloadDistributionConfig`: Процентное распределение дел по начальным этапам.
*   **Прямые расчеты/визуализации на странице:**
    *   `FinancialReport`: Отображает таблицы годового Cash Flow и P&L (результаты `generateCashFlow`, `generatePnL`). // Отображение годовых CF и P&L.
    *   `HorizontalCashflowReport`: Отображает **горизонтальную** таблицу месячного Cash Flow, показывая поступления (`inflow`) и затраты по категориям/тегам (используя `generateCashFlow`). // Отображение месячного CF по статьям.
    *   `TimelineVisualizer`: Строит график накопленного Cash Flow (из `generateCashFlow`). // График кумулятивного CF.
    *   `LaborCostDisplay`: Отображает метрики трудозатрат и утилизации (см. Раздел 1). // Метрики трудозатрат.
    *   `DistributionVisualizer`: Отображает диаграмму распределения дел по этапам. // Диаграмма распределения дел.
*   **Влияние на систему:**
    *   `totalCases`, `averageDebtAmount`, `commissionRate` напрямую влияют на расчет выручки в `generateCashFlow`, `generatePnL` и на `calculateBreakEven` (Разделы 3, 4). `totalCases` используется в `distributeCases`. // Параметры портфеля влияют на доход и симуляции.
    *   `discountRate` используется в `calculateNPV` (Раздел 3). // Ставка дисконтирования для NPV.
    *   `taxRate` используется в `generatePnL` (Раздел 4). // Ставка налога для P&L.
    *   `depreciationPeriodYears` используется в `calculateEBITDA` (Раздел 3). // Срок амортизации для EBITDA.
    *   Вероятности из `StageProbabilitiesConfig` являются ключевыми для симуляций `calculateAverageCollectionTime`, `calculateOverallRecoveryRate`, `simulateMonthlyCaseFlow` (Разделы 2, 4). // Вероятности этапов для всех симуляций.
    *   Проценты из `CaseloadDistributionConfig` используются в `distributeCases`, влияя на `calculateRequiredAnnualWorkloadHours` и определяя стартовые точки для симуляций (Разделы 1, 2, 4). // Распределение дел влияет на нагрузку и старт симуляций.

### `HorizontalCashflowReport` (Компонент)
*   **Файлы:** `src/components/FinancialModeling/HorizontalCashflowReport/index.tsx`, `src/components/FinancialModeling/HorizontalCashflowReport/reportUtils.ts`
*   **Назначение:** Отображает детализированный, иерархический отчет о движении денежных средств (Cash Flow) с разбивкой по месяцам или кварталам за выбранный год моделирования. // Показывает подробный CF по статьям.
*   **Логика:**
    *   **Получение данных:** Компонент получает `costList`, `stageList`, `currentPortfolio`, `currentParams`, `caseloadDistribution`, `staffList` из Redux store. // Загрузка исходных данных из state.
    *   **Расчет CF:** Вызывает `generateCashFlow` для получения массива `MonthlyCashFlow[]`, содержащего детальные данные по притокам и оттокам за каждый месяц года (результат основной симуляции). // Вызов основной функции расчета CF.
    *   **Агрегация (`aggregateReportData`):** Эта ключевая функция из `reportUtils.ts` преобразует сырые данные CF и списки затрат/персонала в структурированный формат для таблицы:
        *   Обрабатывает `costList`, распределяя суммы по месяцам согласно периодичности и дате начала в пределах года моделирования (`modelingYear`). // Распределение пользовательских затрат по месяцам.
        *   Добавляет специфические строки: 'Поступления (от взыскания)' (из `generateCashFlow`), 'ФОТ (Фикс.)' (сумма окладов), 'Переменные трудозатраты' (из `generateCashFlow`), 'Отчисления с ФОТ' (расчет годовой суммы, деление на 12), 'НДФЛ' (расчет годовой суммы по каждому сотруднику, суммирование, деление на 12), 'Налог на прибыль' (из `generateCashFlow`). // Добавление расчетных строк (доход, ФОТ, налоги).
        *   Добавляет 'Покупка портфеля', если `isInitialPurchase`=true (рассчитывает стоимость портфеля, применяет % покупки, относит на 1-й месяц). // Добавление стоимости покупки портфеля (если применимо).
        *   Группирует все строки в иерархию: Главная категория (`Операционная` и т.д.) -> Тип (`Доходы`/`Расходы`) -> Детализация (Название затраты/ФОТ/НДФЛ...). // Создание иерархии строк.
        *   Рассчитывает промежуточные итоги по Типам. // Суммы по Доходам/Расходам.
        *   Рассчитывает итоговую строку 'Чистый денежный поток', суммируя итоги по Типам (Доходы с плюсом, Расходы с минусом). // Расчет итогового ЧДП.
        *   Возвращает плоский массив `ReportRow[]` с уровнями вложенности (`level`). // Формирование плоского массива для таблицы.
    *   **Определение года:** Находит самый ранний год из `startDate` в `costList` для заголовка отчета. // Определение года для отчета.
    *   **Переключение периода:** Позволяет пользователю выбрать месячный или квартальный вид. // Переключатель Месяц/Квартал.
    *   **Отображение:** Рендерит таблицу MUI, используя `aggregateReportData` и `getPeriodValue` для отображения сумм за месяц или квартал. Применяет стили для иерархии и выделения строк. // Вывод таблицы.
*   **Отображаемые метрики:** Иерархический отчет CF с детализацией по статьям (Поступления, Операционные расходы (ФОТ, переменные, прочие по тегам), Налоговые расходы (Взносы, НДФЛ, Налог на прибыль), Инвестиционные расходы (Покупка портфеля)), с разбивкой по месяцам/кварталам и годовым итогом. Включает итоговую строку "Чистый денежный поток".
*   **Влияющие параметры:** Все параметры, влияющие на `generateCashFlow` (этапы, персонал, портфель, фин. параметры), а также структура `costList` (названия, суммы, периодичность, даты начала) для детальной разбивки расходов.

---
*Примечание: Симуляции (`simulateMonthlyCaseFlow`, `simulateCaseFlowAndRecovery`, `calculateAverageCollectionTime`) используют упрощенное равномерное распределение вероятностей при наличии нескольких следующих этапов (ветвление графа). `simulateMonthlyCaseFlow` использует максимальную длительность этапа (`durationDays.max`) для определения времени прохождения.*
